name: Build NaiveProxy for HarmonyOS

on:
  push:
    branches: [master, ohos-*]
  pull_request:
    branches: [master]
  workflow_dispatch:
    inputs:
      arch:
        description: 'ç›®æ ‡æž¶æž„'
        required: false
        default: 'arm64'
        type: choice
        options:
          - arm64
          - x64
          - both

defaults:
  run:
    shell: bash

env:
  CACHE_EPOCH: 1

jobs:
  build-ohos-so:
    name: ç¼–è¯‘é¸¿è’™ .so åº“ (${{ matrix.arch }})
    runs-on: ubuntu-22.04

    container:
      image: simtelboyhotyi/ohos-build:latest
      options: --privileged

    strategy:
      fail-fast: false
      matrix:
        arch: ${{ github.event.inputs.arch == 'both' && fromJSON('["arm64", "x64"]') || github.event.inputs.arch == '' && fromJSON('["arm64"]') || fromJSON(format('["{0}"]', github.event.inputs.arch)) }}

    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: éªŒè¯é¸¿è’™ NDK sysroot
        run: |
          echo "========================================="
          echo "éªŒè¯é¸¿è’™ NDK sysroot"
          echo "========================================="
          echo "NDK è·¯å¾„: $OHOS_NDK_HOME"
          echo "Sysroot è·¯å¾„: $OHOS_SYSROOT"
          ls -la $OHOS_SYSROOT/usr/lib
          echo ""
          echo "âœ… é¸¿è’™ sysroot å·²å°±ç»ªï¼"

      - name: ç¼“å­˜ç¼–è¯‘å·¥å…·é“¾
        uses: actions/cache@v4
        with:
          path: |
            src/third_party/llvm-build/Release+Asserts/
            src/gn/
          key: toolchains-ohos-${{ hashFiles('CHROMIUM_VERSION') }}-v${{ env.CACHE_EPOCH }}

      - name: ç¼“å­˜ ccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ccache-ohos-${{ matrix.arch }}-${{ hashFiles('CHROMIUM_VERSION') }}-${{ github.run_number }}
          restore-keys: |
            ccache-ohos-${{ matrix.arch }}-${{ hashFiles('CHROMIUM_VERSION') }}-

      - name: ä¿®æ”¹æž„å»ºé…ç½®æ”¯æŒé¸¿è’™
        working-directory: src
        run: |
          echo "========================================="
          echo "ä¿®æ”¹ GN é…ç½®ä»¥æ”¯æŒé¸¿è’™å¹³å°"
          echo "========================================="

          # 1. ä¿®æ”¹ get-sysroot.sh æ·»åŠ é¸¿è’™æ”¯æŒ
          if ! grep -q "ohos)" get-sysroot.sh; then
            sed -i '/android)/a\  ohos)\n    WITH_SYSROOT=\n  ;;' get-sysroot.sh
          fi

          echo "é…ç½®ä¿®æ”¹å®Œæˆ"

      - name: ä¿®æ”¹ BUILD.gn æ·»åŠ å…±äº«åº“ç›®æ ‡
        working-directory: src
        run: |
          echo "========================================="
          echo "æ·»åŠ  shared_library ç¼–è¯‘ç›®æ ‡"
          echo "========================================="

          # åœ¨ net/BUILD.gn ä¸­æ·»åŠ å…±äº«åº“ç›®æ ‡
          cat >> net/BUILD.gn <<'EOFBUILDGN'

          # é¸¿è’™å…±äº«åº“ç‰ˆæœ¬
          if (target_os == "ohos" || target_os == "android") {
            shared_library("naive_shared") {
              output_name = "naive"

              sources = [
                "tools/naive/http_proxy_server_socket.cc",
                "tools/naive/http_proxy_server_socket.h",
                "tools/naive/naive_config.cc",
                "tools/naive/naive_config.h",
                "tools/naive/naive_connection.cc",
                "tools/naive/naive_connection.h",
                "tools/naive/naive_padding_framer.cc",
                "tools/naive/naive_padding_framer.h",
                "tools/naive/naive_padding_socket.cc",
                "tools/naive/naive_padding_socket.h",
                "tools/naive/naive_protocol.cc",
                "tools/naive/naive_protocol.h",
                "tools/naive/naive_proxy.cc",
                "tools/naive/naive_proxy.h",
                "tools/naive/naive_proxy_bin.cc",
                "tools/naive/naive_proxy_delegate.cc",
                "tools/naive/naive_proxy_delegate.h",
                "tools/naive/redirect_resolver.cc",
                "tools/naive/redirect_resolver.h",
                "tools/naive/socks5_server_socket.cc",
                "tools/naive/socks5_server_socket.h",
              ]

              deps = [
                ":net",
                "//base",
              ]

              configs -= [ "//build/config/gcc:symbol_visibility_hidden" ]
              configs += [ "//build/config/gcc:symbol_visibility_default" ]
            }
          }
          EOFBUILDGN

          echo "BUILD.gn ä¿®æ”¹å®Œæˆ"

      - name: èŽ·å–ç¼–è¯‘å·¥å…·é“¾
        working-directory: src
        run: |
          export EXTRA_FLAGS='target_os="android" target_cpu="${{ matrix.arch }}"'
          ./get-clang.sh

      - name: åˆ›å»º GN é…ç½®æ–‡ä»¶
        working-directory: src
        run: |
          echo "========================================="
          echo "åˆ›å»º GN é…ç½®æ–‡ä»¶"
          echo "========================================="

          # åˆ›å»ºç›®å½•ç»“æž„
          mkdir -p gn/standalone/libc++
          mkdir -p gn/standalone/sanitizers
          mkdir -p gn/standalone/toolchain

          # åˆ›å»º android.gniï¼ˆå¯¼å…¥å·²æœ‰çš„ Android é…ç½®ï¼‰
          cat > gn/standalone/android.gni <<'EOFANDROID'
          # Android configuration for OHOS build
          # Import the existing Android config which already defines these variables
          import("//build/config/android/config.gni")
          EOFANDROID

          # åˆ›å»º libc++.gniï¼ˆå¯¼å…¥å·²æœ‰çš„ c++ é…ç½®ï¼‰
          cat > gn/standalone/libc++/libc++.gni <<'EOFLIBCXX'
          # libc++ configuration for OHOS build
          # Import the existing c++ config which already defines use_custom_libcxx
          import("//build/config/c++/c++.gni")
          EOFLIBCXX

          # åˆ›å»º sanitizers/vars.gniï¼ˆå¯¼å…¥å·²æœ‰çš„ sanitizers é…ç½®ï¼‰
          cat > gn/standalone/sanitizers/vars.gni <<'EOFSANITIZERS'
          # Sanitizers configuration for OHOS build
          # Import the existing sanitizers config which already defines these variables
          import("//build/config/sanitizers/sanitizers.gni")
          EOFSANITIZERS

          # åˆ›å»º toolchain/llvm.gni
          cat > gn/standalone/toolchain/llvm.gni <<'EOFLLVM'
          # LLVM toolchain configuration for OHOS build
          declare_args() {
            # Path to LLVM build directory
            llvm_build_dir = ""
          }

          # Define is_cross_compiling for perfetto
          # This is true when target_os != host_os or target_cpu != host_cpu
          is_cross_compiling = target_os != host_os || target_cpu != host_cpu
          EOFLLVM

          # åˆ›å»º proto_library.gniï¼ˆå¯¼å…¥ perfetto çš„ proto_library é…ç½®ï¼‰
          cat > gn/standalone/proto_library.gni <<'EOFPROTO'
          # Proto library configuration for OHOS build
          # Import the existing perfetto proto_library config
          import("//third_party/perfetto/gn/standalone/proto_library.gni")
          EOFPROTO

          echo "GN é…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ"

      - name: é…ç½®ç¼–è¯‘å‚æ•°
        working-directory: src
        run: |
          echo "========================================="
          echo "é…ç½®ç¼–è¯‘å‚æ•°"
          echo "========================================="

          export EXTRA_FLAGS='target_os="android" target_cpu="${{ matrix.arch }}"'
          export TMPDIR="$PWD/tmp"
          mkdir -p "$TMPDIR"

          FLAGS='
            is_official_build=true
            exclude_unwind_tables=true
            enable_resource_allowlist_generation=false
            symbol_level=0

            is_clang=true
            use_sysroot=false

            fatal_linker_warnings=false
            treat_warnings_as_errors=false

            is_cronet_build=true
            chrome_pgo_phase=0

            enable_base_tracing=false
            use_perfetto_client_library=false
            use_udev=false
            use_aura=false
            use_ozone=false
            use_gio=false
            use_platform_icu_alternatives=true
            use_glib=false

            disable_file_support=true
            enable_websockets=false
            use_kerberos=false
            enable_mdns=false
            enable_reporting=false
            include_transport_security_state_preload_list=false
            enable_device_bound_sessions=false
            enable_bracketed_proxy_uris=true
            enable_quic_proxy_support=true

            use_nss_certs=false

            enable_backup_ref_ptr_support=false
            enable_dangling_raw_ptr_checks=false
            enable_shadow_metadata=false
          '

          FLAGS="$FLAGS
            default_min_sdk_version=24
            is_high_end_android=true
          "

          ./gn/out/gn gen "out/Release-ohos-${{ matrix.arch }}" --args="$FLAGS $EXTRA_FLAGS"

      - name: ç¼–è¯‘å…±äº«åº“
        working-directory: src
        run: |
          echo "========================================="
          echo "å¼€å§‹ç¼–è¯‘ libnaive.so"
          echo "========================================="

          ccache -z
          ninja -C "out/Release-ohos-${{ matrix.arch }}" naive_shared
          ccache -s

          echo "========================================="
          echo "ç¼–è¯‘å®Œæˆ"
          echo "========================================="

      - name: æ£€æŸ¥ç¼–è¯‘äº§ç‰©
        working-directory: src
        run: |
          echo "========================================="
          echo "ç¼–è¯‘äº§ç‰©ä¿¡æ¯"
          echo "========================================="

          SO_FILE="out/Release-ohos-${{ matrix.arch }}/libnaive.so"

          if [ -f "$SO_FILE" ]; then
            echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
            echo ""
            echo "æ–‡ä»¶ä¿¡æ¯:"
            ls -lh "$SO_FILE"
            echo ""
            echo "æ–‡ä»¶ç±»åž‹:"
            file "$SO_FILE"
            echo ""
            echo "ä¾èµ–åº“:"
            readelf -d "$SO_FILE" | grep NEEDED || true
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼šæ‰¾ä¸åˆ° $SO_FILE"
            exit 1
          fi

      - name: æ‰“åŒ…äº§ç‰©
        working-directory: src
        run: |
          BUNDLE="libnaive-ohos-${{ matrix.arch }}"
          mkdir -p "$BUNDLE"

          cp "out/Release-ohos-${{ matrix.arch }}/libnaive.so" "$BUNDLE/"
          cp config.json ../LICENSE ../USAGE.txt "$BUNDLE/" || true

          cat > "$BUNDLE/README.md" <<'EOFREADME'
          # NaiveProxy é¸¿è’™å…±äº«åº“

          ## æ–‡ä»¶è¯´æ˜Ž

          - `libnaive.so` - NaiveProxy æ ¸å¿ƒåº“
          - `config.json` - é…ç½®æ–‡ä»¶ç¤ºä¾‹

          ## ä½¿ç”¨æ–¹æ³•

          ### é›†æˆåˆ°é¸¿è’™åº”ç”¨

          1. å°† `libnaive.so` å¤åˆ¶åˆ°ä½ çš„é¸¿è’™é¡¹ç›®ï¼š
             ```
             YourHarmonyApp/entry/libs/arm64-v8a/libnaive.so
             ```

          2. åœ¨ ArkTS ä¸­è°ƒç”¨ï¼š
             ```typescript
             import naive from 'libnaive.so';
             ```

          ## æž¶æž„

          - arm64-v8a: é¸¿è’™æ‰‹æœºï¼ˆARM64ï¼‰
          - x86_64: é¸¿è’™æ¨¡æ‹Ÿå™¨

          ## è®¸å¯è¯

          BSD License
          EOFREADME

          tar czf "$BUNDLE.tar.gz" "$BUNDLE"
          sha256sum "out/Release-ohos-${{ matrix.arch }}/libnaive.so" > sha256sum.txt
          echo "SHA256SUM=$(cut -d' ' -f1 sha256sum.txt)" >> $GITHUB_ENV

      - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: libnaive-ohos-${{ matrix.arch }}-sha256-${{ env.SHA256SUM }}
          path: |
            src/libnaive-ohos-${{ matrix.arch }}.tar.gz
            src/sha256sum.txt
          retention-days: 30

      - name: ä¸Šä¼ åˆ° Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            src/libnaive-ohos-${{ matrix.arch }}.tar.gz
            src/sha256sum.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  summary:
    name: ç¼–è¯‘æ‘˜è¦
    needs: build-ohos-so
    runs-on: ubuntu-22.04
    if: always()

    steps:
      - name: ç”Ÿæˆæ‘˜è¦
        run: |
          echo "## ðŸŽ‰ NaiveProxy é¸¿è’™ç‰ˆæœ¬ç¼–è¯‘å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ ç¼–è¯‘äº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "åœ¨ **Artifacts** éƒ¨åˆ†ä¸‹è½½ç¼–è¯‘å¥½çš„ .so æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ ä¸‹ä¸€æ­¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. ä¸‹è½½ \`libnaive-ohos-arm64.tar.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "2. è§£åŽ‹å¾—åˆ° \`libnaive.so\`" >> $GITHUB_STEP_SUMMARY
          echo "3. é›†æˆåˆ°ä½ çš„é¸¿è’™åº”ç”¨é¡¹ç›®" >> $GITHUB_STEP_SUMMARY
          echo "4. å‚è€ƒ README.md è¿›è¡Œå¼€å‘" >> $GITHUB_STEP_SUMMARY
